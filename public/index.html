<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chat Seguro</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Roboto', sans-serif;
      background-color: #111;
      color: #fff;
      display: flex;
      flex-direction: column;
      height: 100vh;
    }
    .header {
      background-color: #222;
      padding: 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .header button {
      background: #28a745;
      border: none;
      color: white;
      padding: 10px 15px;
      border-radius: 10px;
      font-size: 14px;
    }
    #chat {
      flex: 1;
      overflow-y: auto;
      padding: 10px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .message {
      max-width: 70%;
      padding: 10px;
      border-radius: 10px;
      word-wrap: break-word;
      position: relative;
    }
    .you {
      align-self: flex-end;
      background-color: #007bff;
    }
    .other {
      align-self: flex-start;
      background-color: #444;
    }
    .footer {
      display: flex;
      padding: 10px;
      background-color: #222;
      gap: 10px;
    }
    .footer input {
      flex: 1;
      padding: 10px;
      border-radius: 10px;
      border: none;
      background-color: #333;
      color: white;
    }
    .footer button {
      padding: 10px 15px;
      background: #28a745;
      border: none;
      color: white;
      border-radius: 10px;
    }
    .footer input[type="file"] {
      display: none;
    }
    #modal {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      display: none;
    }
    #modalContent {
      background: #222;
      padding: 20px;
      border-radius: 10px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    #modalContent input {
      padding: 10px;
      border-radius: 6px;
      border: none;
      background: #333;
      color: white;
    }
    #modalContent button {
      padding: 10px;
      border: none;
      background: #28a745;
      color: white;
      border-radius: 6px;
    }
    .message-time {
      font-size: 12px;
      color: #aaa;
    }
    .message img {
      max-width: 100%;
      border-radius: 10px;
    }
    .seen-by {
      font-size: 10px;
      color: #aaa;
      margin-top: 3px;
    }
  </style>
</head>
<body>
  <div class="header">
    <div>Chat Seguro</div>
    <button onclick="showModal()">Entrar na sala</button>
  </div>
  <div id="chat"></div>
  <div class="footer">
    <input id="messageInput" placeholder="Digite sua mensagem...">
    <button onclick="sendMessage()">Enviar</button>
    <label for="imageUpload" style="background-color: #007bff; padding: 10px; border-radius: 10px; cursor: pointer;">ðŸ“·</label>
    <input type="file" id="imageUpload" accept="image/*" onchange="handleImageUpload(event)">
  </div>

  <div id="modal">
    <div id="modalContent">
      <input id="username" placeholder="Seu nome">
      <input id="room" placeholder="Nome da sala">
      <button onclick="joinRoom()">Entrar</button>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
  <script>
    const socket = io();
    let username = "", room = "", secretKey;
    const messageStatus = {};

    function showModal() {
      document.getElementById("modal").style.display = "flex";
    }

    socket.on("key", key => secretKey = key);

    function joinRoom() {
      username = document.getElementById("username").value;
      room = document.getElementById("room").value;
      if (!username || !room) return;
      socket.emit("join_room", room);
      document.getElementById("modal").style.display = "none";
      loadMessages();
    }

    function encryptMessage(text, keyHex) {
      const key = CryptoJS.enc.Hex.parse(keyHex);
      const iv = CryptoJS.lib.WordArray.random(16);
      const encrypted = CryptoJS.AES.encrypt(text, key, { iv, mode: CryptoJS.mode.CBC });
      return iv.toString(CryptoJS.enc.Hex) + encrypted.ciphertext.toString(CryptoJS.enc.Hex);
    }

    function decryptMessage(dataHex, keyHex) {
      const key = CryptoJS.enc.Hex.parse(keyHex);
      const iv = CryptoJS.enc.Hex.parse(dataHex.slice(0, 32));
      const encrypted = CryptoJS.enc.Hex.parse(dataHex.slice(32));
      const decrypted = CryptoJS.AES.decrypt({ ciphertext: encrypted }, key, { iv, mode: CryptoJS.mode.CBC });
      return decrypted.toString(CryptoJS.enc.Utf8);
    }

    socket.on("receive_message", encrypted => {
      const decrypted = decryptMessage(encrypted, secretKey);
      const isMine = decrypted.startsWith("[" + username + "]:");
      const text = decrypted.split("]: ")[1];
      const time = new Date().toLocaleTimeString();
      const id = Date.now() + Math.random();
      addMessage(text, isMine ? 'you' : 'other', time, id);
      saveMessage(text, isMine ? 'you' : 'other', time, id);
      if (!isMine) {
        socket.emit("message_seen", { room, id, user: username });
      }
    });

    socket.on("update_seen", ({ id, user }) => {
      const seen = document.querySelector(`[data-id='${id}'] .seen-by`);
      if (seen && !seen.innerText.includes(user)) {
        seen.innerText += ` ${user}`;
      }
    });

    function sendMessage() {
      const msg = document.getElementById("messageInput").value;
      if (!msg || !room || !username) return;
      const fullMsg = `[${username}]: ${msg}`;
      const encrypted = encryptMessage(fullMsg, secretKey);
      const id = Date.now() + Math.random();
      socket.emit("send_message", { room, message: encrypted, id });
      const time = new Date().toLocaleTimeString();
      addMessage(msg, 'you', time, id);
      saveMessage(msg, 'you', time, id);
      document.getElementById("messageInput").value = "";
    }

    function addMessage(text, type, time, id) {
      const chat = document.getElementById("chat");
      const div = document.createElement("div");
      div.className = `message ${type}`;
      div.setAttribute("data-id", id);
      div.innerHTML = `${text} <span class="message-time">${time}</span>
      ${type === 'you' ? '<div class="seen-by">Visto por:</div>' : ''}`;
      chat.appendChild(div);
      chat.scrollTop = chat.scrollHeight;
    }

    function saveMessage(text, type, time, id) {
      const messages = JSON.parse(localStorage.getItem('messages') || '[]');
      messages.push({ text, type, time, id });
      localStorage.setItem('messages', JSON.stringify(messages));
    }

    function loadMessages() {
      const messages = JSON.parse(localStorage.getItem('messages') || '[]');
      messages.forEach(msg => addMessage(msg.text, msg.type, msg.time, msg.id));
    }

    function handleImageUpload(event) {
      const file = event.target.files[0];
      if (file && file.type.startsWith('image/')) {
        const reader = new FileReader();
        reader.onload = function(e) {
          const imageData = e.target.result;
          const time = new Date().toLocaleTimeString();
          const id = Date.now() + Math.random();
          addImageMessage(imageData, 'you', time, id);
          saveMessage('Imagem enviada', 'you', time, id);
          socket.emit("send_message", { room, message: encryptMessage(`[${username}]: [imagem]`, secretKey), id });
        };
        reader.readAsDataURL(file);
      }
    }

    function addImageMessage(imageData, type, time, id) {
      const chat = document.getElementById("chat");
      const div = document.createElement("div");
      div.className = `message ${type}`;
      div.setAttribute("data-id", id);
      div.innerHTML = `<img src="${imageData}" alt="Imagem enviada"> <span class="message-time">${time}</span>
      ${type === 'you' ? '<div class="seen-by">Visto por:</div>' : ''}`;
      chat.appendChild(div);
      chat.scrollTop = chat.scrollHeight;
    }
  </script>
</body>
</html>
