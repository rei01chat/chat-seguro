<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chat Seguro</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Roboto', sans-serif;
      background-color: #222;
      color: #fff;
      display: flex;
      flex-direction: column;
      height: 100vh;
    }
    .header {
      background-color: #333;
      padding: 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      color: #fff;
      border-bottom: 2px solid #555;
    }
    .header .header-right {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    #status-indicator {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background-color: green;
    }
    #chat {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
      background-color: #222;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .message {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 12px;
      border-radius: 8px;
      max-width: 75%;
      font-size: 14px;
      line-height: 1.4;
      word-wrap: break-word;
      position: relative;
    }
    .message.you {
      align-self: flex-end;
      background-color: #007bff;
      color: #fff;
    }
    .message.other {
      align-self: flex-start;
      background-color: #555;
      color: #fff;
    }
    .message-time {
      font-size: 12px;
      color: #ccc;
      margin-left: 8px;
      white-space: nowrap;
    }
    .message-status {
      font-size: 12px;
      color: #ccc;
      margin-left: 4px;
      white-space: nowrap;
    }
    .footer {
      display: flex;
      align-items: center;
      padding: 12px;
      background-color: #333;
      gap: 10px;
      border-top: 2px solid #555;
    }
    .footer input[type="text"] {
      flex: 1;
      padding: 10px 15px;
      border-radius: 20px;
      border: none;
      background-color: #555;
      color: white;
      font-size: 14px;
    }
    .footer button {
      padding: 10px 15px;
      background: #28a745;
      border: none;
      color: white;
      border-radius: 20px;
      cursor: pointer;
      font-size: 14px;
    }
    .footer label {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 40px;
      height: 40px;
      background-color: #007bff;
      border-radius: 50%;
      cursor: pointer;
    }
    .footer input[type="file"] { display: none; }
    #modal {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      display: none;
      align-items: center;
      justify-content: center;
    }
    #modalContent {
      background: #333;
      padding: 20px;
      border-radius: 10px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      min-width: 280px;
    }
    #modalContent input {
      padding: 10px;
      border-radius: 6px;
      border: none;
      background: #444;
      color: white;
    }
    #modalContent button {
      padding: 10px;
      border: none;
      background: #28a745;
      color: white;
      border-radius: 6px;
      cursor: pointer;
    }

    /* Tela de Boas-vindas */
    #welcome-screen {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background-color: #222;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: #fff;
      text-align: center;
      font-size: 18px;
      z-index: 9999;
      opacity: 1;
      animation: fadeIn 1s ease-out;
    }

    #welcome-screen h1 {
      font-size: 36px;
      margin-bottom: 20px;
    }

    #welcome-screen p {
      font-size: 20px;
      margin-bottom: 30px;
    }

    #welcome-screen button {
      background-color: #28a745;
      border: none;
      color: white;
      padding: 10px 20px;
      font-size: 16px;
      border-radius: 5px;
      cursor: pointer;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
  </style>
</head>
<body>
  <div id="welcome-screen">
    <h1>Bem-vindo ao Chat Seguro</h1>
    <p>O chat mais seguro para conversas do mundo inteiro. Mensagens criptografadas, imposs√≠veis de serem hackeadas ou grampeadas por qualquer pessoa, at√© mesmo autoridades. Sua privacidade √© nossa prioridade!</p>
    <button onclick="showLoginModal()">OK</button>
  </div>

  <div class="header">
    <div>Chat Seguro</div>
    <div class="header-right">
      <span id="user-status">Online</span>
      <div id="status-indicator"></div>
    </div>
  </div>
  <div id="chat"></div>
  <div class="footer">
    <input id="messageInput" type="text" placeholder="Digite sua mensagem...">
    <button onclick="sendMessage()">Enviar</button>
    <label for="imageUpload">
      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="#fff" viewBox="0 0 24 24">
        <path d="M21 19V5a2 2 0 0 0-2-2H5c-1.105 0-2 .895-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/>
      </svg>
    </label>
    <input type="file" id="imageUpload" accept="image/*" onchange="handleImageUpload(event)">
    <button id="recordBtn" style="background:#ff4081;">üé§</button>
    <button onclick="showModal()" style="background:#ffb74d;">+</button>
  </div>
  <div id="modal">
    <div id="modalContent">
      <p><strong><p style="text-align: center;"><strong>Insira seu nome e o n√∫mero da sala</strong></p></strong></p>
      <p style="text-align: center;">Ap√≥s inserir as informa√ß√µes, voc√™ ser√° redirecionado para a sala privada e an√¥nima.</p>
      <input id="username" placeholder="Seu nome">
      <input id="room" placeholder="Nome da sala">
      <button onclick="joinRoom()">Entrar</button>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
  <script>
    const socket = io();
    let username = "", room = "", secretKey;

    function setUserStatus(status) {
      const s = document.getElementById('user-status');
      const ind = document.getElementById('status-indicator');
      s.textContent = status === 'online' ? 'Online' : 'Offline';
      ind.style.background = status === 'online' ? 'green' : 'gray';
    }

    setUserStatus('online');
    
    // Fun√ß√£o para esconder a tela de boas-vindas e mostrar o modal de login
    function showLoginModal() {
      document.getElementById('welcome-screen').style.display = 'none';
      document.getElementById('modal').style.display = 'flex';
    }

    function showModal() { document.getElementById('modal').style.display = 'flex'; }
    socket.on('key', key => secretKey = key);

    function joinRoom() {
      username = document.getElementById('username').value;
      room = document.getElementById('room').value;
      if (!username || !room) return;
      socket.emit('join_room', room);
      document.getElementById('modal').style.display = 'none';
      loadMessages();
    }

    function encryptMessage(text, keyHex) {
      const key = CryptoJS.enc.Hex.parse(keyHex);
      const iv = CryptoJS.lib.WordArray.random(16);
      const enc = CryptoJS.AES.encrypt(text, key, { iv, mode: CryptoJS.mode.CBC });
      return iv.toString() + enc.ciphertext.toString();
    }

    function decryptMessage(dataHex, keyHex) {
      const key = CryptoJS.enc.Hex.parse(keyHex);
      const iv = CryptoJS.enc.Hex.parse(dataHex.slice(0, 32));
      const ct = CryptoJS.enc.Hex.parse(dataHex.slice(32));
      return CryptoJS.AES.decrypt({ ciphertext: ct }, key, { iv, mode: CryptoJS.mode.CBC }).toString(CryptoJS.enc.Utf8);
    }

    socket.on('receive_message', encrypted => {
      const dec = decryptMessage(encrypted, secretKey);
      const mine = dec.startsWith('[' + username + ']:' );
      const txt = dec.split(']: ')[1];
      const time = new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
      const id = Date.now() + Math.random();
      addMessage(txt, mine ? 'you' : 'other', time, id);
    });

    socket.on('receive_audio', ({ audioBase64, username }) => {
      const audioTag = `<audio controls src="data:audio/webm;base64,${audioBase64}" style="max-width: 200px;"></audio>`;
      const time = new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
      const id = Date.now() + Math.random();
      addMessage(audioTag, 'other', time, id);
    });

    socket.on('update_seen', ({ id }) => {
      const status = document.querySelector(`[data-id='${id}'] .message-status`);
      if (status) status.textContent = '‚úì‚úì';
    });

    function sendMessage() {
      const msg = document.getElementById('messageInput').value;
      if (!msg || !room || !username) return;
      const full = `[${username}]: ${msg}`;
      const enc = encryptMessage(full, secretKey);
      const id = Date.now() + Math.random();
      socket.emit('send_message', { room, message: enc, id });
      const time = new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
      addMessage(msg, 'you', time, id);
      document.getElementById('messageInput').value = '';
    }

    function addMessage(text, type, time, id) {
      const div = document.createElement('div');
      div.classList.add('message', type);
      div.dataset.id = id;
      div.innerHTML = `
        <span class="message-text">${text}</span>
        <span class="message-time">${time}</span>
        <span class="message-status">...</span>
      `;
      document.getElementById('chat').appendChild(div);
      setTimeout(() => {
        document.querySelector(`[data-id='${id}'] .message-status`).textContent = '‚úì';
      }, 1000);
    }

    function loadMessages() {
      socket.emit('load_messages', room);
    }
  </script>
</body>
</html>

